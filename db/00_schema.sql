-- ==============================================================================
-- üèóÔ∏è MASTER SCRIPT : MEEPLE & MILESTONES (vFinal 1.0)
-- Description : Structure, S√©curit√© (RLS), Fonctions RPC et Realtime
-- Auteur : Matthieu Mourier
-- ==============================================================================

-- 0. NETTOYAGE (Reset complet en cas de besoin)
-- DROP TABLE IF EXISTS public.plays CASCADE;
-- DROP TABLE IF EXISTS public.challenge_items CASCADE;
-- DROP TABLE IF EXISTS public.challenges CASCADE;
-- DROP TABLE IF EXISTS public.games CASCADE;

-- Reconfiguration du Realtime
-- DROP PUBLICATION IF EXISTS supabase_realtime;
-- CREATE PUBLICATION supabase_realtime;

-- ==============================================================================
-- 1. TABLES & RELATIONS (STRUCTURE)
-- ==============================================================================

-- A. GAMES (Biblioth√®que publique des jeux - Persistante)
CREATE TABLE IF NOT EXISTS public.games (
  id bigint generated by default as identity primary key,
  bgg_id bigint not null unique,
  name text not null,
  thumbnail_url text,
  image_url text,
  description text,
  year_published integer,
  min_age integer,
  playing_time integer,
  rating numeric(3, 1),
  complexity numeric(3, 2),
  min_players integer,
  max_players integer,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- B. CHALLENGES (Le conteneur du d√©fi utilisateur)
CREATE TABLE IF NOT EXISTS public.challenges (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users not null,
  name text default 'Mon Challenge 10x10',
  year integer default 2026,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(user_id, year)
);

-- C. CHALLENGE_ITEMS (Les jeux dans la collection de l'utilisateur)
CREATE TABLE IF NOT EXISTS public.challenge_items (
  id bigint generated by default as identity primary key,
  challenge_id bigint references public.challenges(id) on delete cascade not null,
  game_id bigint references public.games(id) on delete cascade not null,
  progress integer default 0,
  target integer default 10,
  meeple_color text default 'red',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(challenge_id, game_id)
);

-- D. PLAYS (Historique des parties)
CREATE TABLE IF NOT EXISTS public.plays (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users not null,
  game_id bigint references public.games(id) on delete cascade not null, 
  played_on timestamp with time zone default now() not null,
  duration_minutes int default 0,
  player_count int default 1,
  is_victory boolean default false,
  notes text,
  image_urls text[] default array[]::text[],
  created_at timestamp with time zone default now()
);

-- ==============================================================================
-- 2. S√âCURIT√â (ROW LEVEL SECURITY - RLS)
-- ==============================================================================

ALTER TABLE public.games ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.challenges ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.challenge_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.plays ENABLE ROW LEVEL SECURITY;

-- Fonctions Utilitaires
CREATE OR REPLACE FUNCTION public.check_challenge_ownership(challenge_id bigint)
RETURNS boolean AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.challenges
    WHERE id = check_challenge_ownership.challenge_id
    AND user_id = auth.uid()
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION public.handle_new_user() 
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.challenges (user_id, name, year)
  VALUES (new.id, 'Mon Challenge 10x10', 2026);
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger Inscription
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- POLITIQUES (POLICIES)

-- Games
CREATE POLICY "Games_Read_Public" ON public.games FOR SELECT USING (true);
CREATE POLICY "Games_Write_Auth" ON public.games FOR ALL USING (auth.role() = 'authenticated');

-- Challenges
CREATE POLICY "Challenges_Select_Own" ON public.challenges FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Challenges_Insert_Own" ON public.challenges FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Challenges_Delete_Own" ON public.challenges FOR DELETE USING (auth.uid() = user_id);

-- Challenge Items
CREATE POLICY "Items_Select_Own" ON public.challenge_items FOR SELECT USING (public.check_challenge_ownership(challenge_id));
CREATE POLICY "Items_Insert_Own" ON public.challenge_items FOR INSERT WITH CHECK (public.check_challenge_ownership(challenge_id));
CREATE POLICY "Items_Update_Own" ON public.challenge_items FOR UPDATE USING (public.check_challenge_ownership(challenge_id));
CREATE POLICY "Items_Delete_Own" ON public.challenge_items FOR DELETE USING (public.check_challenge_ownership(challenge_id));

-- Plays
CREATE POLICY "Plays_Select_Own" ON public.plays FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Plays_Insert_Own" ON public.plays FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Plays_Update_Own" ON public.plays FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Plays_Delete_Own" ON public.plays FOR DELETE USING (auth.uid() = user_id);

-- ==============================================================================
-- 3. FONCTIONS RPC (Backend Logic)
-- ==============================================================================

-- Suppression de compte s√©curis√©e (Nettoyage en cascade)
CREATE OR REPLACE FUNCTION delete_own_account()
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- 1. Nettoyage des parties
  DELETE FROM public.plays WHERE user_id = auth.uid();
  -- 2. Nettoyage des challenges (cascade sur items)
  DELETE FROM public.challenges WHERE user_id = auth.uid();
  -- 3. Suppression du User Auth
  DELETE FROM auth.users WHERE id = auth.uid();
END;
$$;

GRANT EXECUTE ON FUNCTION delete_own_account() TO authenticated;

-- ==============================================================================
-- 4. REALTIME
-- ==============================================================================

ALTER TABLE public.games REPLICA IDENTITY FULL;
ALTER TABLE public.plays REPLICA IDENTITY FULL;
ALTER TABLE public.challenge_items REPLICA IDENTITY FULL;

-- Note: La commande suivante √©chouera si la publication existe d√©j√†, √† g√©rer manuellement
-- ALTER PUBLICATION supabase_realtime ADD TABLE games, plays, challenge_items;
